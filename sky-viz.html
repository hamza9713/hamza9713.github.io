<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NYC Gentrification & Affordability Crisis</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/three@0.150.1/build/three.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0e14;
            color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Back Navigation Overlay */
        #back-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(7, 14, 27, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: opacity 0.3s ease;
        }

        #back-overlay.show {
            display: flex;
        }

        .exit-content {
            max-width: 500px;
            width: 100%;
            background: rgba(20, 26, 41, 0.9);
            border-radius: 20px;
            padding: 40px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            transform: translateY(20px);
            opacity: 0;
            animation: slideIn 0.5s ease forwards 0.2s;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .exit-title {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #4ECDC4, #45B7D1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .exit-subtitle {
            color: #aaa;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .exit-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .exit-btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 180px;
        }

        .exit-btn.primary {
            background: linear-gradient(135deg, #4ECDC4, #45B7D1);
            color: #0a0e14;
        }

        .exit-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .exit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .exit-btn:active {
            transform: translateY(-1px);
        }

        .mobile-back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 100;
            background: rgba(30, 40, 60, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(78, 205, 196, 0.3);
            color: #4ECDC4;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .mobile-back-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: scale(1.1);
        }

        /* Tooltip Toggle Button */
        .tooltip-toggle-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 100;
            background: rgba(30, 40, 60, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(78, 205, 196, 0.3);
            color: #4ECDC4;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .tooltip-toggle-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: scale(1.1);
        }

        .tooltip-toggle-btn.active {
            background: rgba(78, 205, 196, 0.4);
            border-color: #4ECDC4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        .tooltip-toggle-btn.active i {
            color: #00ff99;
        }

        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* Narrative Panel */
        #narrative-panel {
            width: 420px;
            background: rgba(7, 14, 27, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(33, 71, 68, 0.3);
            padding: 25px;
            overflow-y: auto;
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(4, 4, 4, 0.431);
        }

        .panel-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(78, 205, 196, 0.4);
            position: relative;
        }

        .desktop-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(78, 205, 196, 0.1);
            color: #4ECDC4;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .desktop-back-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateX(-3px);
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ffffff, #beb8b8, #a49b9b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .panel-subtitle {
            font-size: 0.95rem;
            color: #d3cbcb;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.5px;
        }

        .narrative-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(20, 26, 41, 0.6);
            border-radius: 12px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .narrative-section:hover {
            background: rgba(30, 35, 50, 0.8);
            transform: translateX(5px);
        }

        .narrative-section.active {
            background: rgba(30, 40, 60, 0.9);
            border-left: 4px solid #4ECDC4;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1rem;
            color: #4ECDC4;
        }

        .section-content {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ccc;
        }

        .highlight {
            background: rgba(255, 204, 0, 0.15);
            color: #ffcc00;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
        }

        .critical {
            background: rgba(255, 0, 102, 0.15);
            color: #ff0066;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
        }

        .positive {
            background: rgba(0, 255, 153, 0.15);
            color: #00ff99;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
        }

        .viz-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .viz-btn {
            background: rgba(30, 40, 60, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.3);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .viz-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateY(-2px);
        }

        .viz-btn.active {
            background: rgba(78, 205, 196, 0.4);
            border-color: #4ECDC4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        .btn-icon {
            font-size: 1.2rem;
        }

        /* Visualization Area */
        #viz-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #skyline-3d-canvas {
            width: 100%;
            height: 100%;
        }

        /* HUD Overlay */
        .hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .hud-header {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 15, 25, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            pointer-events: auto;
            border: 1px solid rgba(78, 205, 196, 0.3);
            min-width: 300px;
        }

        .hud-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .hud-subtitle {
            font-size: 0.9rem;
            color: #aaa;
            font-family: 'JetBrains Mono', monospace;
        }

        .hud-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .hud-stat {
            display: flex;
            flex-direction: column;
        }

        .hud-stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hud-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4ECDC4;
            font-family: 'JetBrains Mono', monospace;
        }

        .hud-footer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .hud-btn {
            background: rgba(30, 40, 60, 0.9);
            border: 1px solid rgba(100, 100, 120, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 150px;
            justify-content: center;
            pointer-events: auto;
        }

        .hud-btn:hover {
            background: rgba(40, 50, 70, 0.95);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .hud-btn.critical {
            border-color: rgba(255, 0, 102, 0.4);
            background: rgba(255, 0, 102, 0.15);
        }

        .hud-btn.critical:hover {
            background: rgba(255, 0, 102, 0.25);
        }

        .hud-btn.warning {
            border-color: rgba(255, 204, 0, 0.4);
            background: rgba(255, 204, 0, 0.15);
        }

        .hud-btn.warning:hover {
            background: rgba(255, 204, 0, 0.25);
        }

        /* Legend */
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 15, 25, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            pointer-events: auto;
            border: 1px solid rgba(78, 205, 196, 0.3);
            min-width: 200px;
            max-width: 250px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .legend.collapsed {
            transform: translateX(120%);
            opacity: 0;
            pointer-events: none;
        }

        .legend-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .legend-toggle {
            background: none;
            border: none;
            color: #4ECDC4;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .legend-toggle:hover {
            background: rgba(78, 205, 196, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .legend-label {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Narrative Progress */
        .narrative-progress {
            position: absolute;
            bottom: 20px;
            left: 440px;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
        }

        .progress-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(30, 40, 60, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.3);
            color: #4ECDC4;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .progress-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: scale(1.1);
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #45B7D1);
            border-radius: 2px;
            width: 25%;
            transition: width 0.5s ease;
        }

        /* Mobile Tooltip */
        .mobile-tooltip {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 15, 25, 0.98);
            backdrop-filter: blur(20px);
            border-top: 2px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            z-index: 50;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
        }

        .mobile-tooltip.show {
            transform: translateY(0);
        }

        .mobile-tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4ECDC4;
        }

        .tooltip-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tooltip-close-btn:hover {
            background: rgba(255, 0, 102, 0.3);
            border-color: #ff0066;
            transform: rotate(90deg);
        }

        .tooltip-hide-all-btn {
            position: fixed;
            bottom: 130px;
            right: 20px;
            z-index: 51;
            background: rgba(255, 0, 102, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 102, 0.4);
            color: #ff0066;
            padding: 12px 20px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(255, 0, 102, 0.2);
        }

        .tooltip-hide-all-btn:hover {
            background: rgba(255, 0, 102, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 0, 102, 0.3);
        }

        .tooltip-hide-all-btn i {
            font-size: 1rem;
        }

        /* Desktop Tooltip */
        .desktop-tooltip {
            position: fixed;
            background: rgba(10, 15, 25, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 12px;
            padding: 20px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            z-index: 10000;
            pointer-events: none;
            display: none;
            max-width: 350px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            line-height: 1.5;
        }

        .desktop-tooltip.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            #narrative-panel {
                width: 380px;
            }
            
            .hud-footer {
                flex-wrap: wrap;
                justify-content: center;
                width: 90%;
            }
            
            .narrative-progress {
                left: 400px;
            }
        }

        @media (max-width: 1024px) {
            .hud-header {
                min-width: 250px;
                padding: 12px 15px;
            }
            
            .hud-title {
                font-size: 1.1rem;
            }
            
            .hud-subtitle {
                font-size: 0.8rem;
            }
            
            .hud-stats {
                gap: 15px;
            }
            
            .hud-stat-value {
                font-size: 1rem;
            }
            
            .legend {
                max-width: 200px;
                padding: 12px;
            }
        }

        @media (max-width: 900px) {
            #app-container {
                flex-direction: column;
            }
            
            #narrative-panel {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid rgba(78, 205, 196, 0.3);
                padding: 15px;
            }
            
            #viz-area {
                height: 60vh;
            }
            
            .mobile-back-btn {
                display: flex;
            }
            
            .tooltip-toggle-btn {
                display: flex;
            }
            
            .tooltip-hide-all-btn {
                display: flex;
            }
            
            .desktop-back-btn {
                display: none;
            }
            
            .panel-header {
                margin-top: 10px;
            }
            
            .panel-title {
                font-size: 1.5rem;
            }
            
            .panel-subtitle {
                font-size: 0.85rem;
            }
            
            .narrative-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .section-title {
                font-size: 1rem;
            }
            
            .section-content {
                font-size: 0.85rem;
            }
            
            .viz-controls {
                margin-top: 15px;
            }
            
            .viz-btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .hud-header {
                top: 10px;
                left: 10px;
                right: 10px;
                min-width: auto;
            }
            
            .hud-footer {
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
                flex-wrap: wrap;
            }
            
            .hud-btn {
                min-width: 120px;
                padding: 10px 15px;
                font-size: 0.8rem;
                flex: 1;
            }
            
            .legend {
                top: auto;
                bottom: 150px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .narrative-progress {
                left: 50%;
                transform: translateX(-50%);
                bottom: 80px;
            }
            
            .progress-bar {
                width: 150px;
            }
        }

        @media (max-width: 600px) {
            #narrative-panel {
                height: 45vh;
            }
            
            #viz-area {
                height: 55vh;
            }
            
            .panel-title {
                font-size: 1.3rem;
            }
            
            .hud-header {
                padding: 10px;
            }
            
            .hud-title {
                font-size: 1rem;
            }
            
            .hud-stats {
                gap: 10px;
            }
            
            .hud-stat-label {
                font-size: 0.65rem;
            }
            
            .hud-stat-value {
                font-size: 0.9rem;
            }
            
            .hud-footer {
                bottom: 5px;
                gap: 8px;
            }
            
            .hud-btn {
                min-width: 100px;
                padding: 8px 12px;
                font-size: 0.75rem;
            }
            
            .legend {
                bottom: 130px;
                padding: 10px;
            }
            
            .legend-title {
                font-size: 0.8rem;
            }
            
            .legend-label {
                font-size: 0.75rem;
            }
            
            .narrative-progress {
                bottom: 60px;
            }
            
            .progress-btn {
                width: 35px;
                height: 35px;
            }
            
            .progress-bar {
                width: 120px;
            }
            
            .exit-content {
                padding: 25px;
                margin: 15px;
            }
            
            .exit-title {
                font-size: 1.5rem;
            }
            
            .exit-options {
                flex-direction: column;
            }
            
            .exit-btn {
                min-width: 100%;
            }
            
            .tooltip-toggle-btn {
                bottom: 100px;
            }
            
            .tooltip-hide-all-btn {
                bottom: 150px;
                padding: 10px 15px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 400px) {
            #narrative-panel {
                height: 50vh;
                padding: 12px;
            }
            
            #viz-area {
                height: 50vh;
            }
            
            .viz-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .hud-btn {
                font-size: 0.7rem;
                padding: 6px 10px;
            }
            
            .legend {
                bottom: 120px;
            }
            
            .tooltip-toggle-btn {
                bottom: 90px;
            }
            
            .tooltip-hide-all-btn {
                bottom: 140px;
                padding: 8px 12px;
                font-size: 0.7rem;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            #narrative-panel {
                height: 50vh;
            }
            
            #viz-area {
                height: 50vh;
            }
            
            .legend {
                bottom: 100px;
            }
            
            .narrative-progress {
                bottom: 40px;
            }
            
            .tooltip-toggle-btn {
                bottom: 70px;
            }
            
            .tooltip-hide-all-btn {
                bottom: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Exit Overlay -->
    <div id="back-overlay">
        <div class="exit-content">
            <h2 class="exit-title">Exit Visualization</h2>
            <p class="exit-subtitle">Return to projects or continue exploring the NYC gentrification analysis.</p>
            <div class="exit-options">
                <button class="exit-btn primary" id="exit-confirm">
                    <i class="fas fa-sign-out-alt"></i> Return to Projects
                </button>
                <button class="exit-btn secondary" id="exit-cancel">
                    <i class="fas fa-times"></i> Continue Exploring
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Back Button -->
    <div class="mobile-back-btn" id="mobile-back">
        <i class="fas fa-arrow-left"></i>
    </div>

    <!-- Tooltip Toggle Button -->
    <div class="tooltip-toggle-btn" id="toggle-tooltips">
        <i class="fas fa-eye"></i>
    </div>

    <!-- Hide All Tooltips Button -->
    <button class="tooltip-hide-all-btn" id="hide-all-tooltips">
        <i class="fas fa-eye-slash"></i> Hide Tooltips
    </button>

    <div id="app-container">
        <!-- Narrative Panel -->
        <div id="narrative-panel">
            <div class="panel-header">
                <a href="#" class="desktop-back-btn" id="desktop-back">
                    <i class="fas fa-arrow-left"></i> Back to Projects
                </a>
                <h1 class="panel-title">NYC Gentrification Crisis</h1>
                <p class="panel-subtitle">A Narrative Visualization of Housing Affordability & Displacement</p>
            </div>
            
            <div class="narrative-section active" data-section="citywide">
                <div class="section-title">
                    <i class="fas fa-city section-icon"></i>
                    Citywide Trends
                </div>
                <div class="section-content">
                    <p>Analysis of <span class="highlight">2,168 census tracts</span> from 2015 to 2022 shows intensifying market pressures and worsening affordability.</p>
                    <p>The citywide GMI rose from <span class="highlight">0.000 in 2015 to 0.208 in 2022</span>, with a mean tract-level score of <span class="highlight">0.038</span>.</p>
                    <p><span class="highlight">92.8% of tracts</span> showed low to moderate gentrification momentum, but <span class="critical">7.2% (155 tracts)</span> were classified as high or critical risk.</p>
                </div>
            </div>
            
            <div class="narrative-section" data-section="borough">
                <div class="section-title">
                    <i class="fas fa-map-marked-alt section-icon"></i>
                    Borough-Level Disparities
                </div>
                <div class="section-content">
                    <p>Significant differences in gentrification and displacement vulnerability across boroughs.</p>
                    <p><span class="critical">Manhattan</span> has the highest mean weighted GMI at <span class="critical">0.283</span>, median rent of <span class="critical">$1,881</span>, and income of <span class="critical">$91,148</span>.</p>
                    <p><span class="positive">The Bronx</span> has a negative mean GMI of <span class="positive">-0.325</span>, poverty rate of <span class="positive">27.1%</span>, and lowest median rent at <span class="positive">$1,263</span>.</p>
                </div>
            </div>
            
            <div class="narrative-section" data-section="high-risk">
                <div class="section-title">
                    <i class="fas fa-exclamation-triangle section-icon"></i>
                    High-Risk Tract Analysis
                </div>
                <div class="section-content">
                    <p><span class="critical">21 census tracts</span> classified as high displacement risk show urgent conditions for policy intervention.</p>
                    <p>GMI values range from <span class="critical">0.069 to 2.167</span> (mean <span class="critical">0.822</span>).</p>
                    <p>Median monthly rents range from <span class="critical">$2,525 to $3,501</span>, exceeding affordability for households earning below <span class="critical">$101,000 to $140,000</span> annually.</p>
                </div>
            </div>
            
            <div class="narrative-section" data-section="affordability">
                <div class="section-title">
                    <i class="fas fa-chart-line section-icon"></i>
                    False Affordability Gap
                </div>
                <div class="section-content">
                    <p>A comparative analysis reveals a significant measurement gap between LAI and HUD's metropolitan AMI.</p>
                    <p>HUD's 2023 baseline suggests <span class="highlight">96.9% of NYC tracts</span> appear affordable.</p>
                    <p>Using the LAI adjusted for neighborhood conditions, only <span class="critical">54.5% of tracts</span> genuinely meet affordability criteria.</p>
                    <p>This <span class="critical">42.4 percentage-point discrepancy</span> highlights the "false affordability zone."</p>
                </div>
            </div>
            
            <div class="viz-controls">
                <button class="viz-btn active" data-action="flyto-nyc">
                    <span><i class="fas fa-globe-americas btn-icon"></i> NYC Overview</span>
                    <span class="highlight">Key: 1</span>
                </button>
                <button class="viz-btn" data-action="flyto-manhattan">
                    <span><i class="fas fa-building btn-icon"></i> Manhattan</span>
                    <span class="critical">Key: 2</span>
                </button>
                <button class="viz-btn" data-action="flyto-brooklyn">
                    <span><i class="fas fa-bridge btn-icon"></i> Brooklyn</span>
                    <span class="highlight">Key: 3</span>
                </button>
                <button class="viz-btn" data-action="flyto-bronx">
                    <span><i class="fas fa-tree btn-icon"></i> The Bronx</span>
                    <span class="positive">Key: 4</span>
                </button>
                <button class="viz-btn" data-action="flyto-queens">
                    <span><i class="fas fa-umbrella-beach btn-icon"></i> Queens</span>
                    <span class="highlight">Key: 5</span>
                </button>
            </div>
        </div>
        
        <!-- Visualization Area -->
        <div id="viz-area">
            <div id="skyline-3d-canvas"></div>
            
            <!-- HUD Overlay -->
            <div class="hud-overlay">
                <div class="hud-header">
                    <div class="hud-title">NYC Gentrification Dashboard</div>
                    <div class="hud-subtitle">Advanced 3D Visualization â€¢ 2,168 Census Tracts</div>
                    <div class="hud-stats">
                        <div class="hud-stat">
                            <div class="hud-stat-label">Total Tracts</div>
                            <div class="hud-stat-value" id="tract-count">0</div>
                        </div>
                        <div class="hud-stat">
                            <div class="hud-stat-label">High Risk</div>
                            <div class="hud-stat-value" id="high-risk-count">0</div>
                        </div>
                        <div class="hud-stat">
                            <div class="hud-stat-label">Avg GMI</div>
                            <div class="hud-stat-value" id="avg-gmi">0.000</div>
                        </div>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-title">
                        <span>GMI Classification</span>
                        <button class="legend-toggle" id="toggle-legend">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff0066;"></div>
                        <div class="legend-label">Critical Risk (>0.822)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6600;"></div>
                        <div class="legend-label">High Risk (>0.208)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffcc00;"></div>
                        <div class="legend-label">Moderate (>0.038)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff99;"></div>
                        <div class="legend-label">Low Pressure (>0)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ccff;"></div>
                        <div class="legend-label">Stable/Improving (â‰¤0)</div>
                    </div>
                </div>
                
                <div class="hud-footer">
                    <button class="hud-btn" id="focus-high-risk">
                        <i class="fas fa-exclamation-triangle"></i> Focus High Risk
                    </button>
                    <button class="hud-btn warning" id="focus-false-affordability">
                        <i class="fas fa-home"></i> False Affordability Zones
                    </button>
                    <button class="hud-btn critical" id="highlight-displacement">
                        <i class="fas fa-people-carry"></i> Highlight Displacement
                    </button>
                </div>
                
                <div class="narrative-progress">
                    <button class="progress-btn" id="prev-narrative">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <button class="progress-btn" id="next-narrative">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Tooltip -->
    <div class="mobile-tooltip" id="mobile-tooltip">
        <div class="mobile-tooltip-header">
            <div class="tooltip-title" id="tooltip-title">Tract Details</div>
            <button class="tooltip-close-btn" id="close-tooltip">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="tooltip-content"></div>
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="hud-btn" id="dismiss-all-tooltips" style="width: 100%; padding: 10px; font-size: 0.8rem;">
                <i class="fas fa-eye-slash"></i> Don't Show More Tooltips
            </button>
        </div>
    </div>

    <!-- Desktop Tooltip -->
    <div class="desktop-tooltip" id="desktop-tooltip">
        <div id="desktop-tooltip-content"></div>
    </div>

    <script>
        class EnhancedSkylineViz {
            constructor(containerId) {
                this.containerId = containerId;
                this.mapboxToken = 'pk.eyJ1IjoiaGFtemE5NzEzIiwiYSI6ImNtazB4eGhkNTAwM2szZ29leWJ5bzkxNzQifQ.5SDMfgkGfOKSBOkMDIqWWw';
                this.map = null;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.tractData = [];
                this.instancedMesh = null;
                this.dummy = new THREE.Object3D();
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.hoveredIndex = -1;
                this.clock = new THREE.Clock();
                this.animationId = null;
                this.currentNarrative = 'citywide';
                this.highlightedTracts = new Set();
                this.highlightPulse = 0;
                this.isMobile = window.innerWidth <= 900;
                this.lastHoverTime = 0;
                this.hoverThrottle = 100;
                this.tooltipsEnabled = true;
                this.legendVisible = true;
            }

            async init() {
                try {
                    await this.loadAllData();
                    this.cityStats = {};

                    const numericKeys = [
                        'gmi',
                        'rent',
                        'income',
                        'poverty_rate',
                        'homeownership_rate',
                        'displacement_risk'
                    ];

                    numericKeys.forEach(k => {
                        const values = this.tractData
                            .map(t => t[k])
                            .filter(v => typeof v === 'number' && !isNaN(v));

                        this.cityStats[k] = {
                            values,
                            avg: values.reduce((a, b) => a + b, 0) / values.length
                        };
                    });

                    if (this.tractData.length === 0) throw new Error('No valid tract data found');
                    
                    await this.initMapbox();
                    this.create3DLayer();
                    this.setupInteractions();
                    this.updateUI();
                    
                    this.animate();
                    
                    console.log(`âœ… ${this.tractData.length} tracts visualized`);
                    console.log(`ðŸ“± Mobile mode: ${this.isMobile}`);
                } catch (error) {
                    console.error('âŒ', error);
                    this.showError(error.message);
                }
            }

            async loadAllData() {
                const [geoRes, aggRes, skylineRes] = await Promise.all([
                    fetch('data/nyc_fault_lines.geojson').catch(() => null),
                    fetch('data/aggregated_data_json.json').catch(() => null),
                    fetch('data/skyline_analytic_payload.json').catch(() => null)
                ]);

                const tractMap = new Map();

                if (geoRes?.ok) {
                    const geojson = await geoRes.json();
                    if (geojson.features) {
                        geojson.features.forEach(feature => {
                            const geoid = feature.properties.GEOID;
                            const lat = parseFloat(feature.properties.INTPTLAT);
                            const lon = parseFloat(feature.properties.INTPTLON);
                            
                            if (geoid && !isNaN(lat) && !isNaN(lon)) {
                                tractMap.set(geoid, {
                                    id: geoid,
                                    lat,
                                    lon,
                                    geometry: feature.geometry
                                });
                            }
                        });
                    }
                }

                if (skylineRes?.ok) {
                    const skylineData = await skylineRes.json();
                    Object.entries(skylineData).forEach(([geoid, data]) => {
                        const tract = tractMap.get(geoid) || {};
                        tractMap.set(geoid, {
                            ...tract,
                            id: geoid,
                            lon: data.lon ?? tract.lon,
                            lat: data.lat ?? tract.lat,
                            gmi: data.gmi ?? 0,
                            gmi_class: data.gmi_class,
                            rent: data.median_rent ?? 0,
                            income: data.median_household_income ?? 0,
                            rent_income_ratio: data.rent_income_ratio,
                            lai_gap: data.lai_gap,
                            displacement_risk: data.displacement_risk ?? 0
                        });
                    });
                }

                if (aggRes?.ok) {
                    const aggData = await aggRes.json();
                    Object.entries(aggData).forEach(([geoid, data]) => {
                        const tract = tractMap.get(geoid) || {};
                        tractMap.set(geoid, {
                            ...tract,
                            id: geoid,
                            neighborhood: data.neighborhood,
                            borough: data.borough,
                            year: data.year,
                            rent: data.medianRent ?? tract.rent,
                            income: data.medianIncome ?? tract.income,
                            poverty_rate: data.povertyRate,
                            homeownership_rate: data.homeownershipRate,
                            gmi: data.gmi ?? tract.gmi,
                            dvi: data.dvi ?? tract.displacement_risk,
                            missing_middle: data.missingMiddle,
                            middle_income_affordable: data.middleIncomeAffordable,
                            local_affordability_mismatch: data.localAffordabilityMismatch,
                            federal_affordability_mismatch: data.federalAffordabilityMismatch,
                            false_affordability_zone: data.falseAffordabilityZone,
                            high_displacement_risk: data.highDisplacementRisk
                        });
                    });
                }

                this.tractData = Array.from(tractMap.values()).filter(t => t.lon && t.lat);
                
                if (this.tractData.length === 0) {
                    console.log('No data loaded, creating mock data for demonstration');
                    this.createMockData();
                }
                
                console.log(`âœ“ Final dataset: ${this.tractData.length} complete tracts`);
            }

            createMockData() {
                this.tractData = [];
                const boroughs = [
                    { name: 'Manhattan', center: [-73.97, 40.78], gmiBase: 0.283, rentBase: 1881, incomeBase: 91148 },
                    { name: 'Brooklyn', center: [-73.95, 40.65], gmiBase: 0.142, rentBase: 1700, incomeBase: 72000 },
                    { name: 'Queens', center: [-73.82, 40.72], gmiBase: 0.085, rentBase: 1600, incomeBase: 68000 },
                    { name: 'Bronx', center: [-73.87, 40.85], gmiBase: -0.325, rentBase: 1263, incomeBase: 42000 },
                    { name: 'Staten Island', center: [-74.15, 40.58], gmiBase: 0.045, rentBase: 1500, incomeBase: 75000 }
                ];
                
                let id = 0;
                boroughs.forEach(borough => {
                    const tractCount = 400 + Math.floor(Math.random() * 100);
                    for (let i = 0; i < tractCount; i++) {
                        const lon = borough.center[0] + (Math.random() - 0.5) * 0.3;
                        const lat = borough.center[1] + (Math.random() - 0.5) * 0.2;
                        
                        let gmi = borough.gmiBase + (Math.random() - 0.5) * 0.2;
                        if (i < 12 && borough.name === 'Manhattan') gmi = 0.822 + Math.random() * 1.0;
                        
                        const rent = borough.rentBase * (0.8 + Math.random() * 0.4);
                        const income = borough.incomeBase * (0.7 + Math.random() * 0.6);
                        const rentIncomeRatio = (rent * 12) / income;
                        
                        this.tractData.push({
                            id: `3600${id.toString().padStart(4, '0')}`,
                            geoid: `3600${id.toString().padStart(4, '0')}`,
                            lon,
                            lat,
                            gmi,
                            gmi_class: gmi > 0.822 ? 'Critical Risk' : 
                                     gmi > 0.208 ? 'High Risk' : 
                                     gmi > 0.038 ? 'Moderate' : 
                                     gmi > 0 ? 'Low Pressure' : 'Stable/Improving',
                            rent,
                            income,
                            rent_income_ratio: rentIncomeRatio,
                            displacement_risk: gmi > 0.5 ? 0.7 + Math.random() * 0.3 : Math.random() * 0.5,
                            borough: borough.name,
                            neighborhood: `${borough.name} Tract ${i+1}`,
                            poverty_rate: borough.name === 'Bronx' ? 0.27 : 0.15 + Math.random() * 0.1,
                            homeownership_rate: 0.3 + Math.random() * 0.5,
                            false_affordability_zone: rentIncomeRatio > 0.3 && income > 60000,
                            high_displacement_risk: gmi > 0.822,
                            lai_gap: rentIncomeRatio > 0.3 ? 500 + Math.random() * 2000 : 0
                        });
                        id++;
                    }
                });
            }

            async initMapbox() {
                mapboxgl.accessToken = this.mapboxToken;
                
                this.map = new mapboxgl.Map({
                    container: this.containerId,
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [-73.95, 40.73],
                    zoom: this.isMobile ? 9.5 : 10.5,
                    pitch: this.isMobile ? 45 : 60,
                    bearing: -17.6,
                    antialias: true,
                    interactive: true,
                    attributionControl: false
                });

                return new Promise((resolve) => {
                    this.map.on('load', () => {
                        console.log('âœ“ Mapbox initialized');
                        resolve();
                    });
                });
            }

            create3DLayer() {
                const modelOrigin = [-73.95, 40.73];
                const modelAltitude = 0;
                const modelRotate = [Math.PI / 2, 0, 0];
                const modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
                    modelOrigin,
                    modelAltitude
                );
                const modelTransform = {
                    translateX: modelAsMercatorCoordinate.x,
                    translateY: modelAsMercatorCoordinate.y,
                    translateZ: modelAsMercatorCoordinate.z,
                    rotateX: modelRotate[0],
                    rotateY: modelRotate[1],
                    rotateZ: modelRotate[2],
                    scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()
                };

                const customLayer = {
                    id: '3d-model',
                    type: 'custom',
                    renderingMode: '3d',
                    onAdd: (map, gl) => {
                        this.camera = new THREE.Camera();
                        this.scene = new THREE.Scene();

                        this.scene.add(new THREE.AmbientLight(0xffffff, 0.4));

                        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
                        dirLight.position.set(100, 200, 100).normalize();
                        this.scene.add(dirLight);

                        const pointLight1 = new THREE.PointLight(0x00ffff, 1.5, 6000);
                        pointLight1.position.set(-2000, 1800, 2000);
                        this.scene.add(pointLight1);

                        const pointLight2 = new THREE.PointLight(0xff00ff, 1.5, 6000);
                        pointLight2.position.set(2000, 1800, -2000);
                        this.scene.add(pointLight2);

                        const pointLight3 = new THREE.PointLight(0xffff00, 1.2, 5000);
                        pointLight3.position.set(0, 2500, 0);
                        this.scene.add(pointLight3);

                        this.createHexagonalMesh();

                        this.renderer = new THREE.WebGLRenderer({
                            canvas: map.getCanvas(),
                            context: gl,
                            antialias: true
                        });
                        this.renderer.autoClear = false;
                        this.renderer.shadowMap.enabled = true;
                        this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                        this.renderer.toneMappingExposure = 1.4;
                    },
                    render: (gl, matrix) => {
                        const rotationX = new THREE.Matrix4().makeRotationAxis(
                            new THREE.Vector3(1, 0, 0),
                            modelTransform.rotateX
                        );
                        const rotationY = new THREE.Matrix4().makeRotationAxis(
                            new THREE.Vector3(0, 1, 0),
                            modelTransform.rotateY
                        );
                        const rotationZ = new THREE.Matrix4().makeRotationAxis(
                            new THREE.Vector3(0, 0, 1),
                            modelTransform.rotateZ
                        );

                        const m = new THREE.Matrix4().fromArray(matrix);
                        const l = new THREE.Matrix4()
                            .makeTranslation(
                                modelTransform.translateX,
                                modelTransform.translateY,
                                modelTransform.translateZ
                            )
                            .scale(
                                new THREE.Vector3(
                                    modelTransform.scale,
                                    -modelTransform.scale,
                                    modelTransform.scale
                                )
                            )
                            .multiply(rotationX)
                            .multiply(rotationY)
                            .multiply(rotationZ);

                        this.camera.projectionMatrix = m.multiply(l);
                        
                        const time = this.clock.getElapsedTime();
                        this.highlightPulse = Math.sin(time * 2) * 0.5 + 0.5;
                        
                        if (this.instancedMesh?.material?.uniforms) {
                            this.instancedMesh.material.uniforms.time.value = time;
                            this.instancedMesh.material.uniforms.hoveredIndex.value = this.hoveredIndex;
                            this.instancedMesh.material.uniforms.highlightPulse.value = this.highlightPulse;
                        }
                        
                        this.renderer.resetState();
                        this.renderer.render(this.scene, this.camera);
                        this.map.triggerRepaint();
                    }
                };

                this.map.addLayer(customLayer);
                console.log('âœ“ 3D hexagonal layer added');
            }

            createHexagonalMesh() {
                const count = this.tractData.length;
                
                const hexGeo = new THREE.CylinderGeometry(1, 1, 1, 6);
                
                const mat = new THREE.ShaderMaterial({
                    uniforms: {
                        time: { value: 0 },
                        hoveredIndex: { value: -1 },
                        highlightPulse: { value: 0 }
                    },
                    vertexShader: `
                        uniform float time;
                        uniform float hoveredIndex;
                        uniform float highlightPulse;
                        
                        attribute float instanceId;
                        attribute float isHighlighted;
                        
                        varying vec3 vPos;
                        varying vec3 vNorm;
                        varying vec3 vColor;
                        varying float vHovered;
                        varying float vHighlighted;
                        
                        void main() {
                            vPos = position;
                            vNorm = normal;
                            vColor = instanceColor;
                            vHovered = (instanceId == hoveredIndex) ? 1.0 : 0.0;
                            vHighlighted = isHighlighted;
                            
                            vec3 scaledPos = position;
                            if (vHovered > 0.5) {
                                scaledPos *= 1.3;
                            }
                            
                            if (vHighlighted > 0.5) {
                                float pulse = 1.0 + highlightPulse * 0.3;
                                scaledPos *= pulse;
                            }
                            
                            vec4 worldPos = instanceMatrix * vec4(scaledPos, 1.0);
                            gl_Position = projectionMatrix * modelViewMatrix * worldPos;
                        }
                    `,
                    fragmentShader: `
                        uniform float time;
                        uniform float highlightPulse;
                        
                        varying vec3 vPos;
                        varying vec3 vNorm;
                        varying vec3 vColor;
                        varying float vHovered;
                        varying float vHighlighted;
                        
                        void main() {
                            float heightFactor = (vPos.y + 0.5);
                            
                            float glow = pow(heightFactor, 2.5) * 1.5;
                            
                            float pulse = sin(time * 2.0 + heightFactor * 3.0) * 0.2 + 0.8;
                            
                            float scanline = sin(vPos.y * 100.0 + time * 3.0) * 0.1 + 0.9;
                            
                            vec3 viewDir = normalize(vec3(0.0, 0.0, 1.0));
                            float fresnel = pow(1.0 - abs(dot(vNorm, viewDir)), 4.0);
                            float edgeGlow = fresnel * 0.8;
                            
                            float hoverGlow = vHovered * 0.5;
                            
                            float highlightGlow = 0.0;
                            if (vHighlighted > 0.5) {
                                highlightGlow = highlightPulse * 0.5;
                            }
                            
                            vec3 finalColor = vColor * (glow + edgeGlow + hoverGlow + highlightGlow) * scanline * pulse;
                            
                            if (vHovered > 0.5) {
                                finalColor *= 1.5;
                            }
                            
                            if (vHighlighted > 0.5) {
                                finalColor = mix(finalColor, vec3(1.0, 1.0, 1.0), highlightPulse * 0.3);
                            }
                            
                            gl_FragColor = vec4(finalColor, 0.9);
                        }
                    `,
                    transparent: true,
                    side: THREE.DoubleSide,
                    depthWrite: true
                });

                this.instancedMesh = new THREE.InstancedMesh(hexGeo, mat, count);
                this.instancedMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);

                const instanceIds = new Float32Array(count);
                const isHighlighted = new Float32Array(count);
                
                for (let i = 0; i < count; i++) {
                    instanceIds[i] = i;
                    isHighlighted[i] = 0;
                }
                
                hexGeo.setAttribute('instanceId', new THREE.InstancedBufferAttribute(instanceIds, 1));
                hexGeo.setAttribute('isHighlighted', new THREE.InstancedBufferAttribute(isHighlighted, 1));

                const color = new THREE.Color();
                const scaleFactor = this.isMobile ? 0.7 : 1.0;
                
                this.tractData.forEach((tract, i) => {
                    const x = (tract.lon - (-73.95)) * 111320 * Math.cos(40.73 * Math.PI / 180);
                    const z = (tract.lat - 40.73) * 111320;
                    
                    const gmi = tract.gmi ?? 0;
                    const height = 80 + Math.abs(gmi) * 2200 * scaleFactor;
                    
                    this.dummy.position.set(x, height / 2, z);
                    this.dummy.scale.set(75 * scaleFactor, height, 75 * scaleFactor);
                    this.dummy.updateMatrix();
                    this.instancedMesh.setMatrixAt(i, this.dummy.matrix);
                    
                    if (gmi > 0.822) color.setHex(0xff0066);
                    else if (gmi > 0.208) color.setHex(0xff6600);
                    else if (gmi > 0.038) color.setHex(0xffcc00);
                    else if (gmi > 0) color.setHex(0x00ff99);
                    else color.setHex(0x00ccff);
                    
                    this.instancedMesh.setColorAt(i, color);
                });

                this.instancedMesh.instanceMatrix.needsUpdate = true;
                if (this.instancedMesh.instanceColor) {
                    this.instancedMesh.instanceColor.needsUpdate = true;
                }

                this.scene.add(this.instancedMesh);
                
                const particleGeo = new THREE.BufferGeometry();
                const positions = new Float32Array(1200 * 3);
                for (let i = 0; i < 1200; i++) {
                    positions[i * 3] = (Math.random() - 0.5) * 28000;
                    positions[i * 3 + 1] = Math.random() * 3500;
                    positions[i * 3 + 2] = (Math.random() - 0.5) * 28000;
                }
                particleGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const particles = new THREE.Points(
                    particleGeo,
                    new THREE.PointsMaterial({
                        color: 0x00ffff,
                        size: 10,
                        transparent: true,
                        opacity: 0.5,
                        blending: THREE.AdditiveBlending
                    })
                );
                this.scene.add(particles);

                console.log(`âœ“ ${count} hexagonal instances created`);
            }

            setupInteractions() {
                // Throttled hover handler
                const handleHover = (e) => {
                    if (!this.tooltipsEnabled) return;
                    
                    const now = Date.now();
                    if (now - this.lastHoverTime < this.hoverThrottle) return;
                    this.lastHoverTime = now;
                    
                    this.onMouseMove(e);
                };

                this.map.on('mousemove', handleHover);
                this.map.on('touchmove', (e) => {
                    if (!this.tooltipsEnabled) return;
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        const mouseEvent = {
                            point: { x: touch.clientX, y: touch.clientY },
                            originalEvent: touch
                        };
                        handleHover(mouseEvent);
                    }
                });
                
                this.map.on('click', (e) => this.onClick(e));
                this.map.on('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        const clickEvent = {
                            point: { x: touch.clientX, y: touch.clientY },
                            originalEvent: touch
                        };
                        this.onClick(clickEvent);
                    }
                });

                // Setup keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === '1') this.flyToNYC();
                    if (e.key === '2') this.flyToBorough('Manhattan');
                    if (e.key === '3') this.flyToBorough('Brooklyn');
                    if (e.key === '4') this.flyToBorough('Bronx');
                    if (e.key === '5') this.flyToBorough('Queens');
                    if (e.key === 'h') this.highlightHighRisk();
                    if (e.key === 'f') this.highlightFalseAffordability();
                    if (e.key === 'd') this.highlightDisplacement();
                    if (e.key === 'Escape') this.showExitOverlay();
                    if (e.key === 't' || e.key === 'T') this.toggleTooltips();
                    if (e.key === 'l' || e.key === 'L') this.toggleLegend();
                });

                // Setup narrative section clicks
                document.querySelectorAll('.narrative-section').forEach(section => {
                    section.addEventListener('click', () => {
                        const narrative = section.dataset.section;
                        this.activateNarrative(narrative);
                    });
                });

                // Setup control buttons
                document.querySelectorAll('.viz-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.currentTarget.dataset.action;
                        this.handleControlAction(action);
                    });
                });

                // Setup HUD buttons
                document.getElementById('focus-high-risk').addEventListener('click', () => this.highlightHighRisk());
                document.getElementById('focus-false-affordability').addEventListener('click', () => this.highlightFalseAffordability());
                document.getElementById('highlight-displacement').addEventListener('click', () => this.highlightDisplacement());

                // Setup narrative navigation
                document.getElementById('prev-narrative').addEventListener('click', () => this.prevNarrative());
                document.getElementById('next-narrative').addEventListener('click', () => this.nextNarrative());

                // Setup exit buttons
                document.getElementById('mobile-back').addEventListener('click', () => this.showExitOverlay());
                document.getElementById('desktop-back').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showExitOverlay();
                });
                
                // Setup exit overlay buttons
                document.getElementById('exit-confirm').addEventListener('click', () => {
                    window.location.href = 'projects.html';
                });
                
                document.getElementById('exit-cancel').addEventListener('click', () => {
                    this.hideExitOverlay();
                });

                // Setup tooltip toggle buttons
                document.getElementById('toggle-tooltips').addEventListener('click', () => {
                    this.toggleTooltips();
                });

                document.getElementById('hide-all-tooltips').addEventListener('click', () => {
                    this.disableTooltips();
                });

                document.getElementById('dismiss-all-tooltips').addEventListener('click', () => {
                    this.disableTooltips();
                    this.hideMobileTooltip();
                });

                // Setup mobile tooltip close button
                document.getElementById('close-tooltip').addEventListener('click', () => {
                    this.hideMobileTooltip();
                });

                // Setup legend toggle
                document.getElementById('toggle-legend').addEventListener('click', () => {
                    this.toggleLegend();
                });

                // Close mobile tooltip when clicking outside
                document.addEventListener('click', (e) => {
                    const tooltip = document.getElementById('mobile-tooltip');
                    const closeBtn = document.getElementById('close-tooltip');
                    const hideAllBtn = document.getElementById('hide-all-tooltips');
                    
                    if (tooltip.classList.contains('show') && 
                        !tooltip.contains(e.target) && 
                        e.target !== closeBtn &&
                        e.target !== hideAllBtn &&
                        !hideAllBtn.contains(e.target)) {
                        this.hideMobileTooltip();
                    }
                });

                // Handle window resize
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 900;
                    this.updateMobileUI();
                });

                // Initial UI update
                this.updateMobileUI();
            }

            updateMobileUI() {
                if (this.isMobile) {
                    document.getElementById('toggle-tooltips').style.display = 'flex';
                    document.getElementById('hide-all-tooltips').style.display = 'flex';
                } else {
                    document.getElementById('toggle-tooltips').style.display = 'none';
                    document.getElementById('hide-all-tooltips').style.display = 'none';
                }
            }

            toggleTooltips() {
                this.tooltipsEnabled = !this.tooltipsEnabled;
                const toggleBtn = document.getElementById('toggle-tooltips');
                const hideAllBtn = document.getElementById('hide-all-tooltips');
                
                if (this.tooltipsEnabled) {
                    toggleBtn.classList.remove('active');
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    hideAllBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Tooltips';
                    hideAllBtn.style.display = 'flex';
                } else {
                    toggleBtn.classList.add('active');
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    hideAllBtn.innerHTML = '<i class="fas fa-eye"></i> Show Tooltips';
                    hideAllBtn.style.display = 'flex';
                    this.hideMobileTooltip();
                    this.hideDesktopTooltip();
                }
                
                // Show notification
                this.showNotification(
                    this.tooltipsEnabled ? 'Tooltips Enabled' : 'Tooltips Disabled',
                    this.tooltipsEnabled ? '#00ff99' : '#ff0066'
                );
            }

            disableTooltips() {
                this.tooltipsEnabled = false;
                const toggleBtn = document.getElementById('toggle-tooltips');
                const hideAllBtn = document.getElementById('hide-all-tooltips');
                
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                hideAllBtn.innerHTML = '<i class="fas fa-eye"></i> Show Tooltips';
                
                this.hideMobileTooltip();
                this.hideDesktopTooltip();
                
                this.showNotification('Tooltips Disabled', '#ff0066');
            }

            enableTooltips() {
                this.tooltipsEnabled = true;
                const toggleBtn = document.getElementById('toggle-tooltips');
                const hideAllBtn = document.getElementById('hide-all-tooltips');
                
                toggleBtn.classList.remove('active');
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                hideAllBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Tooltips';
                
                this.showNotification('Tooltips Enabled', '#00ff99');
            }

            toggleLegend() {
                this.legendVisible = !this.legendVisible;
                const legend = document.querySelector('.legend');
                const toggleBtn = document.getElementById('toggle-legend');
                
                if (this.legendVisible) {
                    legend.classList.remove('collapsed');
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    legend.classList.add('collapsed');
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                }
            }

            handleControlAction(action) {
                switch(action) {
                    case 'flyto-nyc':
                        this.flyToNYC();
                        break;
                    case 'flyto-manhattan':
                        this.flyToBorough('Manhattan');
                        break;
                    case 'flyto-brooklyn':
                        this.flyToBorough('Brooklyn');
                        break;
                    case 'flyto-bronx':
                        this.flyToBorough('Bronx');
                        break;
                    case 'flyto-queens':
                        this.flyToBorough('Queens');
                        break;
                }
                
                document.querySelectorAll('.viz-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.action === action) {
                        btn.classList.add('active');
                    }
                });
            }

            activateNarrative(narrative) {
                this.currentNarrative = narrative;
                
                document.querySelectorAll('.narrative-section').forEach(s => {
                    s.classList.remove('active');
                });
                
                document.querySelector(`.narrative-section[data-section="${narrative}"]`).classList.add('active');
                
                const sections = ['citywide', 'borough', 'high-risk', 'affordability'];
                const index = sections.indexOf(narrative);
                const progress = ((index + 1) / sections.length) * 100;
                document.getElementById('progress-fill').style.width = `${progress}%`;
                
                switch(narrative) {
                    case 'citywide':
                        this.flyToNYC();
                        this.clearHighlights();
                        break;
                    case 'borough':
                        this.flyToNYC();
                        this.highlightBoroughComparison();
                        break;
                    case 'high-risk':
                        this.highlightHighRisk();
                        break;
                    case 'affordability':
                        this.highlightFalseAffordability();
                        break;
                }
            }

            prevNarrative() {
                const sections = ['citywide', 'borough', 'high-risk', 'affordability'];
                const currentIndex = sections.indexOf(this.currentNarrative);
                if (currentIndex > 0) {
                    this.activateNarrative(sections[currentIndex - 1]);
                }
            }

            nextNarrative() {
                const sections = ['citywide', 'borough', 'high-risk', 'affordability'];
                const currentIndex = sections.indexOf(this.currentNarrative);
                if (currentIndex < sections.length - 1) {
                    this.activateNarrative(sections[currentIndex + 1]);
                }
            }

            flyToNYC() {
                this.map.flyTo({
                    center: [-73.95, 40.73],
                    zoom: this.isMobile ? 9.5 : 10.5,
                    pitch: this.isMobile ? 45 : 60,
                    bearing: -17.6,
                    duration: 2000
                });
            }

            flyToBorough(borough) {
                const boroughCenters = {
                    'Manhattan': { 
                        center: [-73.97, 40.78], 
                        zoom: this.isMobile ? 11 : 12, 
                        pitch: this.isMobile ? 50 : 65, 
                        bearing: 30 
                    },
                    'Brooklyn': { 
                        center: [-73.95, 40.65], 
                        zoom: this.isMobile ? 10 : 11, 
                        pitch: this.isMobile ? 45 : 60, 
                        bearing: 0 
                    },
                    'Bronx': { 
                        center: [-73.87, 40.85], 
                        zoom: this.isMobile ? 11 : 12, 
                        pitch: this.isMobile ? 55 : 70, 
                        bearing: -45 
                    },
                    'Queens': { 
                        center: [-73.82, 40.72], 
                        zoom: this.isMobile ? 10 : 11, 
                        pitch: this.isMobile ? 40 : 55, 
                        bearing: 90 
                    },
                    'Staten Island': { 
                        center: [-74.15, 40.58], 
                        zoom: this.isMobile ? 10 : 11, 
                        pitch: this.isMobile ? 35 : 50, 
                        bearing: 0 
                    }
                };
                
                if (boroughCenters[borough]) {
                    const config = boroughCenters[borough];
                    this.map.flyTo({
                        center: config.center,
                        zoom: config.zoom,
                        pitch: config.pitch,
                        bearing: config.bearing,
                        duration: 2000
                    });
                }
            }

            highlightHighRisk() {
                this.clearHighlights();
                this.highlightedTracts.clear();
                
                this.tractData.forEach((tract, i) => {
                    if (tract.gmi > 0.822) {
                        this.highlightedTracts.add(i);
                    }
                });
                
                this.updateHighlightAttributes();
                
                const highRiskTracts = this.tractData.filter(t => t.gmi > 0.822);
                if (highRiskTracts.length > 0) {
                    const lons = highRiskTracts.map(t => t.lon);
                    const lats = highRiskTracts.map(t => t.lat);
                    const bounds = [[Math.min(...lons), Math.min(...lats)], [Math.max(...lons), Math.max(...lats)]];
                    
                    this.map.fitBounds(bounds, {
                        padding: this.isMobile ? 50 : 100,
                        duration: 2000,
                        pitch: this.isMobile ? 45 : 60
                    });
                }
            }

            highlightFalseAffordability() {
                this.clearHighlights();
                this.highlightedTracts.clear();
                
                this.tractData.forEach((tract, i) => {
                    if (tract.false_affordability_zone) {
                        this.highlightedTracts.add(i);
                    }
                });
                
                this.updateHighlightAttributes();
            }

            highlightDisplacement() {
                this.clearHighlights();
                this.highlightedTracts.clear();
                
                this.tractData.forEach((tract, i) => {
                    if (tract.high_displacement_risk) {
                        this.highlightedTracts.add(i);
                    }
                });
                
                this.updateHighlightAttributes();
            }

            highlightBoroughComparison() {
                this.clearHighlights();
                this.highlightedTracts.clear();
                
                this.tractData.forEach((tract, i) => {
                    if (tract.borough === 'Manhattan' || tract.borough === 'Bronx') {
                        this.highlightedTracts.add(i);
                    }
                });
                
                this.updateHighlightAttributes();
            }

            clearHighlights() {
                this.highlightedTracts.clear();
                this.updateHighlightAttributes();
            }

            updateHighlightAttributes() {
                if (!this.instancedMesh) return;
                
                const geometry = this.instancedMesh.geometry;
                const attribute = geometry.getAttribute('isHighlighted');
                
                for (let i = 0; i < this.tractData.length; i++) {
                    attribute.setX(i, this.highlightedTracts.has(i) ? 1 : 0);
                }
                
                attribute.needsUpdate = true;
            }

            onMouseMove(e) {
                const features = this.map.queryRenderedFeatures(e.point, { layers: ['3d-model'] });
                
                if (features.length > 0 && this.instancedMesh) {
                    const rect = this.map.getCanvas().getBoundingClientRect();
                    this.mouse.x = (e.point.x / rect.width) * 2 - 1;
                    this.mouse.y = -(e.point.y / rect.height) * 2 + 1;

                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersects = this.raycaster.intersectObject(this.instancedMesh);

                    if (intersects.length > 0) {
                        const idx = intersects[0].instanceId;
                        if (idx !== this.hoveredIndex && idx < this.tractData.length) {
                            this.hoveredIndex = idx;
                            if (this.isMobile) {
                                this.showMobileTooltip(this.tractData[idx]);
                            } else {
                                this.showDesktopTooltip(this.tractData[idx], e.originalEvent);
                            }
                        }
                    } else if (this.hoveredIndex !== -1) {
                        this.hoveredIndex = -1;
                        if (this.isMobile) {
                            this.hideMobileTooltip();
                        } else {
                            this.hideDesktopTooltip();
                        }
                    }
                } else if (this.hoveredIndex !== -1) {
                    this.hoveredIndex = -1;
                    if (this.isMobile) {
                        this.hideMobileTooltip();
                    } else {
                        this.hideDesktopTooltip();
                    }
                }
            }

            onClick(e) {
                if (this.hoveredIndex !== -1 && !this.isMobile) {
                    console.log('Selected tract:', this.tractData[this.hoveredIndex]);
                }
            }

            showDesktopTooltip(tract, e) {
                const tooltip = document.getElementById('desktop-tooltip');
                const content = document.getElementById('desktop-tooltip-content');
                
                content.innerHTML = this.getTooltipHTML(tract);
                tooltip.classList.add('show');
                
                // Position tooltip intelligently
                let left = e.clientX + 15;
                let top = e.clientY + 15;
                
                // Check if tooltip goes off the right edge
                if (left + tooltip.offsetWidth > window.innerWidth) {
                    left = e.clientX - tooltip.offsetWidth - 15;
                }
                
                // Check if tooltip goes off the bottom edge
                if (top + tooltip.offsetHeight > window.innerHeight) {
                    top = e.clientY - tooltip.offsetHeight - 15;
                }
                
                tooltip.style.left = `${Math.max(10, left)}px`;
                tooltip.style.top = `${Math.max(10, top)}px`;
            }

            showMobileTooltip(tract) {
                const tooltip = document.getElementById('mobile-tooltip');
                const content = document.getElementById('tooltip-content');
                const title = document.getElementById('tooltip-title');
                
                title.textContent = tract.neighborhood || 'Census Tract Details';
                content.innerHTML = this.getTooltipHTML(tract);
                tooltip.classList.add('show');
            }

            getTooltipHTML(tract) {
                return `
                    <div style="color: #999; font-size: 0.85em; margin-bottom: 10px;">
                        ${tract.borough || 'NYC'} â€¢ ${tract.id}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; font-size: 0.85em; margin-bottom: 12px;">
                        <div style="color: #7b7676;">GMI Score:</div>
                        <div style="color: ${tract.gmi > 0.208 ? '#ff0066' : '#00ff99'}; font-weight: bold;">
                            ${(tract.gmi ?? 0).toFixed(3)}
                        </div>
                        
                        <div style="color: #888;">Displacement Risk:</div>
                        <div style="color: #ffcc00; font-weight: bold;">
                            ${((tract.displacement_risk ?? 0) * 100).toFixed(0)}%
                        </div>
                        
                        <div style="color: #888;">Median Income:</div>
                        <div style="color: #00ffff;">$${tract.income > 0 ? Math.round(tract.income).toLocaleString() : 'N/A'}</div>
                        
                        <div style="color: #888;">Median Rent:</div>
                        <div style="color: #ff6600;">$${tract.rent > 0 ? Math.round(tract.rent).toLocaleString() : 'N/A'}</div>
                        
                        <div style="color: #888;">Rent/Income Ratio:</div>
                        <div style="color: ${(tract.rent_income_ratio ?? 0) > 0.3 ? '#ff0066' : '#00ff99'}; font-weight: bold;">
                            ${((tract.rent_income_ratio ?? 0) * 100).toFixed(1)}%
                        </div>
                    </div>
                    
                    ${tract.lai_gap ? `
                    <div style="background: rgba(255,204,0,0.1); padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ffcc00;">
                        <div style="font-size: 0.8em; color: #ffcc00; font-weight: bold;">LOCAL AFFORDABILITY GAP</div>
                        <div style="font-size: 0.85em; color: #fff; margin-top: 4px;">
                            ${tract.lai_gap > 0 ? '+' : ''}$${Math.round(tract.lai_gap).toLocaleString()}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
                        ${tract.high_displacement_risk ? '<span style="background: #ff0066; color: #000; padding: 3px 8px; border-radius: 8px; font-size: 0.75em; font-weight: bold;">ðŸš¨ HIGH DISPLACEMENT RISK</span>' : ''}
                        ${tract.false_affordability_zone ? '<span style="background: #ffcc00; color: #000; padding: 3px 8px; border-radius: 8px; font-size: 0.75em; font-weight: bold;">âš ï¸ FALSE AFFORDABILITY ZONE</span>' : ''}
                    </div>
                `;
            }

            hideDesktopTooltip() {
                const tooltip = document.getElementById('desktop-tooltip');
                tooltip.classList.remove('show');
            }

            hideMobileTooltip() {
                const tooltip = document.getElementById('mobile-tooltip');
                tooltip.classList.remove('show');
            }

            showExitOverlay() {
                document.getElementById('back-overlay').classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            hideExitOverlay() {
                document.getElementById('back-overlay').classList.remove('show');
                document.body.style.overflow = '';
            }

            showNotification(message, color) {
                // Remove existing notification
                const existing = document.getElementById('notification');
                if (existing) existing.remove();
                
                // Create new notification
                const notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(10, 15, 25, 0.95);
                    backdrop-filter: blur(20px);
                    border: 1px solid ${color};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    z-index: 10000;
                    font-family: 'Inter', sans-serif;
                    font-size: 0.9rem;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    transform: translateX(120%);
                    transition: transform 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;
                
                notification.innerHTML = `
                    <i class="fas fa-info-circle" style="color: ${color};"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(120%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
            }

            updateUI() {
                const highRisk = this.tractData.filter(t => (t.gmi ?? 0) > 0.208 || t.high_displacement_risk).length;
                const falseAffordability = this.tractData.filter(t => t.false_affordability_zone).length;
                
                document.getElementById('tract-count').textContent = this.tractData.length.toLocaleString();
                document.getElementById('high-risk-count').textContent = highRisk.toLocaleString();
                
                const avgGMI = this.tractData.reduce((sum, t) => sum + (t.gmi || 0), 0) / this.tractData.length;
                document.getElementById('avg-gmi').textContent = avgGMI.toFixed(3);
            }

            showError(msg) {
                console.error('Visualization error:', msg);
                alert(`Error: ${msg}. Check console for details.`);
            }

            destroy() {
                if (this.animationId) cancelAnimationFrame(this.animationId);
                if (this.map) this.map.remove();
                if (this.scene) {
                    this.scene.traverse(obj => {
                        if (obj.geometry) obj.geometry.dispose();
                        if (obj.material) {
                            if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                            else obj.material.dispose();
                        }
                    });
                }
            }
        }

        // Initialize the visualization when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const viz = new EnhancedSkylineViz('skyline-3d-canvas');
            viz.init();
            
            // Make viz accessible globally for debugging
            window.viz = viz;
            
            // Activate first narrative section
            viz.activateNarrative('citywide');

            // Handle ESC key for exit overlay
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    viz.showExitOverlay();
                }
            });
        });
    </script>
</body>
</html>